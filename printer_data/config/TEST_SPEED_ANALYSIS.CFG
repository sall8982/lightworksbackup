[gcode_macro TEST_SPEED_ANALYSIS]
description: "속도/가속도 테스트 + ADXL345 진동 측정 + 위치 비교 + 로그 기록"
gcode:
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    {% set iterations = params.ITERATIONS|default(3)|int %}
    {% set bound = params.BOUND|default(20)|int %}
    {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}
    {% set log_id = "TEST_SPEED_LOG_X%.0f_Y%.0f" % (printer.toolhead.position.x, printer.toolhead.position.y) %}

    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    {% set x_center = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2 %}
    {% set y_center = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y) / 2 %}
    {% set x_center_min = x_center - (smallpatternsize / 2) %}
    {% set x_center_max = x_center + (smallpatternsize / 2) %}
    {% set y_center_min = y_center - (smallpatternsize / 2) %}
    {% set y_center_max = y_center + (smallpatternsize / 2) %}

    SAVE_GCODE_STATE NAME=TEST_SPEED_ANALYSIS
    G90
    M400
    G28

    { action_respond_info("LOG_START: %s" % log_id) }
    GET_POSITION
    QUERY_ENDSTOPS

    { action_respond_info("ADXL345 진동 측정 시도") }
    MEASURE_AXES_NOISE AXES=xy DURATION=2.0
    SHAPER_CALIBRATE AXES=xy
    { action_respond_info("Input Shaper 튜닝 완료") }

    {% set prev_x = printer.toolhead.position.x %}
    {% set prev_y = printer.toolhead.position.y %}

    G0 Z{bound + 10} F600
    G0 X{x_max - 3} Y{y_max - 3} F13000

    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} SQUARE_CORNER_VELOCITY=8.0

    {% for i in range(iterations) %}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}

        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}

        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}

        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    {% set curr_x = printer.toolhead.position.x %}
    {% set curr_y = printer.toolhead.position.y %}
    {% set delta_x = curr_x - prev_x %}
    {% set delta_y = curr_y - prev_y %}
    { action_respond_info("ΔX: %.3f, ΔY: %.3f" % (delta_x, delta_y)) }

    GET_POSITION
    { action_respond_info("LOG_END: %s" % log_id) }

    RESTORE_GCODE_STATE NAME=TEST_SPEED_ANALYSIS
    STATUS_READY