## Voron Design VORON2 250/300/350mm  TMC2209 UART config
# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.


## *** THINGS TO CHANGE/CHECK: ***
## MCU paths                            [mcu] section
## Thermistor types                     [extruder] and [heater_bed] sections - See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types
## Z Endstop Switch location            [safe_z_home] section
## Homing end position                  [gcode_macro G32] section
## Z Endstop Switch  offset for Z0      [stepper_z] section
## Probe points                         [quad_gantry_level] section
## Min & Max gantry corner postions     [quad_gantry_level] section
## PID tune                             [extruder] and [heater_bed] sections
## Fine tune E steps                    [extruder] section

#=================== 각종 명령어 ==================================================

#=================== PID_CALIBRATE ==================================================
# PID_CALIBRATE HEATER=heater_bed target=80
# PID_CALIBRATE HEATER=extruder target=250

# TUNING_TOWER COMMAND='SET_HEATER_TEMPERATURE HEATER=extruder' PARAMETER=TARGET START=235 FACTOR=-1 BAND=10.0


#  g28 x y
#  CARTOGRAPHER_TOUCH_CALIBRATE MAX=5000 START=800

#=================== INPUTSHAPER ==================================================
##  1   : ACCELEROMETER_QUERY CHIP=sbcanth
##  1-1 : ACCELEROMETER_QUERY CHIP=nozzle
##  2   : SHAPER_CALIBRATE
##  3   : SAVE_CONFIG

###########  푸르사 슬라이서 프린터설정 텝 수동G코드에  넣을것 ##########

#   M140 S[first_layer_bed_temperature]
#   M190 S[first_layer_bed_temperature]
#   M104 S[first_layer_temperature]
#   M109 S[first_layer_temperature]
#   print_start
###   지코드 형식은   klipper
###   프린터 설정텝   g코드 축소판       16x16/QOI, 220x124/QOI, 200x240/QOI, 640x480/PNG, 64x64/PNG, 400x300/PNG  

###########  큐라 슬라이서 프린터설정 텝 수동G코드에  넣을것 ##########
#  print_start BED_TEMP={material_bed_temperature_layer_0} EXTRUDER_TEMP={material_print_temperature_layer_0}




[printer]
kinematics: corexy
max_velocity: 250   # max  220 입니다. 넘어가면 탈조 발생함...  모터 바꾸고 나서부터...
max_accel: 8000         # 5000 이 출력 잘되는 기본값  !
max_z_velocity: 5      # ai 추천 for 24V
max_z_accel: 25        # ai 추천 for 24V
minimum_cruise_ratio: 0.5   # 최신 클리퍼 권장값 (기존 0.25보다 부드러움)
square_corner_velocity: 5.0 # 기본값 5.0

################################## <<<<<<<<    MY MCUS >>>>>>>> ##########################################################

####   [mcu rpi]            serial: /tmp/klipper_host_mcu
####   [mcu]                usb-Klipper_stm32g0b1xx_480012000B50345033313820-if00 -> ../../ttyACM1     skr mini e3 3.0             canbus_uuid: 99f04b11a77b    120 ohm
####   [mcu z]              usb-Klipper_stm32g0b1xx_32001F000B50345033313820-if00 -> ../../ttyACM2     skr mini e3 3.0             canbus_uuid: f9cac514d5b7    non
####   [mcu scanner]        #serial: /dev/serial/by-id/usb-cartographer                                CARTOGRAPHER 5.1.0          canbus_uuid: d34c83c11fe1  
####   [mcu sb_can_th]      usb-Klipper_stm32f072xb_20003C000757435433353320-if00 -> ../../ttyACM0     sb combo v2                 canbus_uuid: 56192b23f5ed    120 ohm



# pi@raspberrypi:~ $ python3 ~/katapult/scripts/flashtool.py -i can0 -q
# Resetting all bootloader node IDs...
# Checking for Katapult nodes...
# Detected UUID: 99f04b11a77b, Application: Klipper
# Detected UUID: d34c83c11fe1, Application: Klipper
# Detected UUID: 56192b23f5ed, Application: Klipper
# Detected UUID: f9cac514d5b7, Application: Klipper
# CANBus UUID Query Complete





##########################################################################################################################
[mcu]
canbus_uuid: 99f04b11a77b



[mcu mcu_z]
canbus_uuid: f9cac514d5b7


[mcu sb_can_th]
canbus_uuid: 56192b23f5ed


[mcu rpi]
serial: /tmp/klipper_host_mcu

[mcu cartographer]
canbus_uuid: d34c83c11fe1

#serial: /dev/serial/by-id/usb-cartographer
#    adjust to suit your scanner, if using usb change to serial

[cartographer]
mcu: cartographer           
##   Offsets are measured from the centre of your coil, to the tip of your nozzle 
##   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
##    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 25
verbose: yes # For extra output

[axis_twist_compensation]

#####################################################################
#   include Settings
#####################################################################
[include main_light.cfg]
[include CLIENT_VARIABLE.cfg]
[include SB_Combo_V2.cfg]
[include mainsail.cfg]
[include stealthburner_leds.cfg]   ######## 툴헤드 rgb조명 효과    sb_led   ########
[include led_effects.cfg]
[include macro.cfg]
[include power.cfg]
[include testspeed.cfg]
[include timelapse.cfg]
[include fan.cfg]
[include nozzle_scrub.cfg]
[include adxl345.cfg]
[include TEST_SPEED_ANALYSIS.CFG]         ######  TEST_SPEED_ANALYSIS SPEED=300 ACCEL=13000 ITERATIONS=3     ---> 사용명령
[include APPLY_RECOMMENDED_SHAPER.CFG]    ###### APPLY_RECOMMENDED_SHAPER  ---> 사용명령
[include moonraker_obico_macros.cfg]
#[include filament_runout_sensor.cfg]     ###### 툴헤드 런아웃센서 사용 안함  #########
#[include firmware_retraction.cfg]
#[include power_printer.cfg]
[firmware_retraction]
[skew_correction]

#########################################################################################################################################
#####################################################################
#   safe_z_home Settings
#####################################################################
[safe_z_home]
home_xy_position:350,249                     ###  베드중앙  Cartographer ###
#home_xy_position:708,468  ###  z endstop    ###  식스볼트 z 엔드스탑     ###
speed: 80
z_hop: 10
z_hop_speed: 5

[idle_timeout]
gcode:
    # 방어막(M104/M140)을 안 부르고 직접 히터를 0으로 만듭니다!
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=50
    M84
    {action_call_remote_method("set_device_power", device="printer", state="off")}
#timeout: 30       ##### 30초 테스트
timeout: 1200    #### 20분

#####################################################################
[gcode_arcs]         ###   원 출력 설정 #######
resolution: 0.1

[exclude_object]      ####  객채재외 기능 #####

[gcode_macro M205]    #### 마린(Marlin) 전용 명령어가 슬라이서에서 출력될때#######
gcode:
 G4
 

##############   firmware_retraction  start ###################
[firmware_retraction]
retract_length: 0.8
# 리트랙션 거리: CW2는 다이렉트 방식이라 0.5~1.0 사이가 적당해요. 
# 0.8로 시작해서 거미줄 보고 조절합시다!

retract_speed: 40
# 당기는 속도: 너무 빠르면 필라멘트 갉아먹으니 40mm/s 정도가 안전해요.

unretract_extra_length: 0
# 다시 밀 때 추가량: 보통은 0인데, 노즐 끝에서 똥이 생기면 마이너스(-) 값을 줍니다.

unretract_speed: 30
# 다시 미는 속도: 당길 때보다는 살짝 천천히 밀어주는 게 기포 방지에 좋아요.

[save_variables]
filename: ~/printer_data/config/variables.cfg
# 변수 저장 파일: 경로를 최근 클리퍼 표준인 printer_data 쪽으로 잡아주는 게 좋습니다.
##############   firmware_retraction  end ###################


#####################################################################
#   X Stepper Settings
#####################################################################
##  Connected to X on mcu_xye (B Motor)
[stepper_x]           
step_pin: PB13      # 스텝 핀 활성화 핀
dir_pin: !PB12      # 모터 회전 방향 (정.역) 
enable_pin: !PB14   # 모터 전원 핀
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 400              #200 for 1.8 degree, 400 for 0.9 degree
endstop_pin: sb_can_th: PA2
position_min: 0
position_endstop: 718         # 720
position_max: 718             # 720     
homing_speed: 80             #Max 100
homing_retract_dist: 10
second_homing_speed: 25
homing_positive_dir: true   

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
interpolate: true     #   true    #   False
run_current: 1.70
#run_current: 1.55
stealthchop_threshold: 0   # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle


#####################################################################
#   Y Stepper Settings
#####################################################################
##  Connected to Y on mcu_xye (A Motor)
[stepper_y]
step_pin: PB10     # 스텝 핀 활성화 핀
dir_pin: PB2      # 모터 회전 방향 (정.역)
enable_pin: !PB11  # 모터 전원 핀
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 400              #200 for 1.8 degree, 400 for 0.9 degree
endstop_pin: sb_can_th: PA3
position_min: 0
position_endstop: 498           # 498
position_max: 498               # 498   
homing_speed: 80               # Max 100
homing_retract_dist: 10
second_homing_speed: 25
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
interpolate: true     #   true    #   False
run_current: 1.70
#run_current: 1.55
stealthchop_threshold: 0     # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle


#####################################################################
#   Z Stepper Settings
#####################################################################
## Z MCU - In X Position
## Z0 Stepper - Front Left
#####################################################################
##  homing_retract_dist: 10    #  옴론센서
##  endstop_pin: ^z:PC2          #  옴론센서 사용 + z_endstop
##  position_endstop:2.4         #  옴론센서 사용 + z_endstop
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)

[stepper_z]
step_pin: mcu_z:PB13
dir_pin: mcu_z:PB12
enable_pin: !mcu_z:PB14
microsteps: 16
full_steps_per_rotation: 200      #200 for 1.8 degree, 400 for 0.9 degree
rotation_distance: 2
position_max: 530
position_min: -8
homing_retract_dist: 0       # cartographer
homing_speed: 20
second_homing_speed: 5
endstop_pin: probe:z_virtual_endstop       

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: mcu_z:PC11
tx_pin: mcu_z:PC10
uart_address: 0
interpolate: true     #   true    #   False
run_current: 0.65
hold_current: 0.5
stealthchop_threshold: 0         # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle
###################################################################
#   Z1 Stepper Settings
#####################################################################
##  Z MCU - In Y Position
##  Z1 Stepper - Rear Left
#####################################################################
[stepper_z1]
step_pin: mcu_z:PB10
dir_pin: mcu_z:PB2
enable_pin: !mcu_z:PB11
microsteps: 16
full_steps_per_rotation: 200          #200 for 1.8 degree, 400 for 0.9 degree
rotation_distance: 2
#endstop_pin: probe:z_virtual_endstop 

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: mcu_z:PC11
tx_pin: mcu_z:PC10
uart_address: 2
interpolate: true     #   true    #   False
run_current: 0.65
hold_current: 0.5
stealthchop_threshold: 0         # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle

#####################################################################
#   Z2 Stepper Settings
#####################################################################
##  Z MCU - In ZAM Position
##  Z2 Stepper - Rear Right
#####################################################################
[stepper_z2]
step_pin: mcu_z:PB0
dir_pin: mcu_z:PC5
enable_pin: !mcu_z:PB1
microsteps: 16
full_steps_per_rotation: 200           #200 for 1.8 degree, 400 for 0.9 degree
rotation_distance: 2
#endstop_pin: probe:z_virtual_endstop 

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: mcu_z:PC11
tx_pin: mcu_z:PC10
uart_address: 1
interpolate: true     #   true    #   False
run_current: 0.65
hold_current: 0.5
stealthchop_threshold: 0          # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle

#####################################################################
#   Z3 Stepper Settings
#####################################################################
##  Z MCU - In E0 Position
##  Z3 Stepper - Front Right
#####################################################################
[stepper_z3]
step_pin: mcu_z:PB3
dir_pin: mcu_z:PB4
enable_pin: !mcu_z:PD1
microsteps: 16
full_steps_per_rotation: 200           #200 for 1.8 degree, 400 for 0.9 degree
rotation_distance: 2
#endstop_pin: probe:z_virtual_endstop 

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: mcu_z:PC11
tx_pin: mcu_z:PC10
uart_address: 3
interpolate: true     #   true    #   False
run_current: 0.65
hold_current: 0.5
stealthchop_threshold: 0         # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle

#####################################################################
#   Extruder
#####################################################################
##  Connected EO on MCU SB_COMBO_V2
#####################################################################
## 22.6789511 is a good starting point  #https://www.service-uplink.de/esteps_cal/calculator.php      Rotation Distance Calculator for Klipper (Extruder)
#rotation_distance: 23.8587659         #기존사용값
#rotation_distance: 24.387659817222   #Bondtech 5mm Drive Gears
#####################################################################    
## Update Gear Ratio depending on your Extruder Type
## Use 50:10 for Stealthburner/Clockwork 2
## Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
## Use 80:20 for M4, M3.1
#####################################################################  

[extruder]
step_pin: sb_can_th:PB3
dir_pin: !sb_can_th:PA8
enable_pin: !sb_can_th:PA15 
rotation_distance: 22.6789511   #Bondtech 5mm Drive Gears
gear_ratio: 50:10               #for Stealthburner/Clockwork2 BMG Gear Ratio
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.40
filament_diameter: 1.75
heater_pin: sb_can_th:PC15
sensor_type: Generic 3950
sensor_pin: sb_can_th:PA6
min_temp: 0  #1 #-273.15 # 1 #zzcatvs mod
max_temp: 280 #360 #99999 # 360 #zzcatvs mod 
max_power: 1.0
min_extrude_temp: 10
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721
##Try to keep pressure_advance below 1.0
pressure_advance: 0.035    
pressure_advance_smooth_time: 0.040    # Default is 0.040, leave stock
max_extrude_cross_section: 5000.0
max_extrude_only_distance: 1000      ####  ai 적용    -안전한 압출 거리를 제한하는 값입니다. 이 값은 노즐이 움직이지 않고 압출만 하는 경우, 즉 G1 E500 같은 명령이 실행될 때 최대 허용 압출 거리를 의미 ####  

[tmc2209 extruder]
uart_pin: sb_can_th:PA10
tx_pin: sb_can_th:PA9
interpolate: true     #### ai 가 적용 모터소음이 클때 true #####
run_current: 0.7     #### ai 가 적용
hold_current: 0.4     #### ai 가 적용
uart_address: 0
#sense_resistor: 0.110
stealthchop_threshold: 0
##diag_pin: sb_can_th:PB5



#####################################################################
#   Bed Heater
#####################################################################
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
[heater_bed]
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
max_power: 1.0
min_temp: -10
max_temp: 130
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769


#####################################################################
#   levellig Settings
#####################################################################
##  Use QUAD_GANTRY_LEVEL to level a gantry.
##  Min & Max gantry corners - measure from nozzle at MIN (0,0) and 
##  to respective belt positions
#####################################################################
[quad_gantry_level]
 gantry_corners:
   10,10
   700,498
   
##  Probe points
 points:           
   30,5
   30,498
   670,498
   670,5
speed: 300
horizontal_move_z: 0
#horizontal_move_z: 3
retries: 15
retry_tolerance: 0.0700
max_adjust: 10


[bed_mesh]
zero_reference_position: 350,249        # home position
speed: 300
horizontal_move_z: 3
mesh_min: 30, 30  
mesh_max: 650, 500 
probe_count: 20,20
adaptive_margin: 10
mesh_pps: 0, 0

#algorithm: bicubic
#bicubic_tension: 0.2
#move_check_distance: 3.0
#split_delta_z: 0.025


#[adaptive_bed_mesh]
#arc_segments: 80                     # (Optional) The number of segments for G2/3 to be decoded into linar motion. 
#mesh_area_clearance: 5               # (Optional) Expand the mesh area outside of the printed area in mm. 
#max_probe_horizontal_distance: 50    # (Optional) Maximum distance between two horizontal probe points in mm. 
#max_probe_vertical_distance: 50      # (Optional) Maximum distance between two vertical probe points in mm.
#use_relative_reference_index: False  # (Optional) For older Klipper (< 0.11.2xx), the `use_relative_reference_index` is used to determine the center point. This is not required for the newer release.
### (Optional) Enable/Disable detection algorithm on demand
#disable_slicer_min_max_boundary_detection: False
#disable_exclude_object_boundary_detection: False
#disable_gcode_analysis_boundary_detection: False


#####################################################################
#####################################################################
#   gcode_macro
#####################################################################
#####################################################################
#[gcode_macro CARTOGRAPHER_TOUCH_V3]
#description = "Home and run Cartographer probing with tuned speed"
#gcode =
#  G28                                  ; 홈잉 먼저 수행
#  G1 Z10 F600                          ; Z축 먼저 올림
##  G1 X{printer.toolhead.position.x} Y{printer.toolhead.position.y} F6000
#  CARTOGRAPHER_TOUCH SPEED=3 ACCEL=100 RETRACT=2 RETRACT_SPEED=10 SAMPLES=3 TOLERANCE=0.02 RETRIES=5 FUZZY=0 DEBUG=1
#  G1 Z10 F600
#  RESPOND MSG="Cartographer probing complete. Z moved to 10mm."


#####################################################################
#   LED Control
#####################################################################
#    STATUS_READY
#    STATUS_OFF
#    STATUS_BUSY
#    STATUS_HEATING
#    STATUS_LEVELING
#    STATUS_HOMING
#    STATUS_CLEANING
#    STATUS_MESHING
#    STATUS_CALIBRATING_Z
#####################################################################
[gcode_macro G32]
description: "Full auto leveling with Cartographer and BED Mesh"
gcode:
    STATUS_READY
    G90
    BED_MESH_CLEAR
    STATUS_HOMING
    G28
    STATUS_READY
    STATUS_LEVELING
    SET_DISPLAY_TEXT MSG="QGL"
    QUAD_GANTRY_LEVEL
    STATUS_READY
    STATUS_HEATING
    M109 S150
    STATUS_READY
    STATUS_HOMING
    SET_DISPLAY_TEXT MSG="CARTOGRAPHER_TOUCH"
    #CARTOGRAPHER_TOUCH_V3
    CARTOGRAPHER_TOUCH_HOME
    STATUS_READY
    STATUS_MESHING
    SET_DISPLAY_TEXT MSG="BED MESH"
    BED_MESH_CALIBRATE
    M109 S0
    BED_MESH_PROFILE SAVE="default"
    BED_MESH_PROFILE LOAD="default"
    STATUS_READY
    G28
#####################################################################
[delayed_gcode _INIT_TIMELAPSE_CHECK_TIME]
initial_duration: 1
gcode: SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=check_time VALUE=0.5 

##########################################################################################################################################  
#   Use  print_start for the slicer ending script - please customise for your slicer of choice
##########################################################################################################################################
[gcode_macro print_start]
gcode:
        SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=check_time VALUE=0.5 
        #  slicer에서 넘어온 변수값   ###  슬라이서에 삽입(큐라) START_PRINT BED_TEMP={material_bed_temperature_layer_0} EXTRUDER_TEMP={material_print_temperature_layer_0}
        {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
      
    STATUS_READY
    SET_GCODE_OFFSET Z=0 ; Reset Z offset   
    STATUS_HOMING
    SET_DISPLAY_TEXT MSG="homeing..." 
    G28
    G90
    status_heating
   
    SET_DISPLAY_TEXT MSG="Heating Bed: {target_bed}°C"   
    M140 S{BED_TEMP}          # Heat bed and wait
    M190 S{BED_TEMP}          # Heat bed and wait
  
   
    SET_DISPLAY_TEXT MSG="clean_nozzle" 
    clean_nozzle
    
    STATUS_LEVELING
    SET_DISPLAY_TEXT MSG="QUAD_GANTRY_LEVELling..." 
    QUAD_GANTRY_LEVEL
    G28 Z                                           기존값
    
    STATUS_MESHING 
    SET_DISPLAY_TEXT MSG="Bed Mesh Calibration" 
    BED_MESH_CLEAR
    #BED_MESH_PROFILE LOAD=default        #### 베드메쉬 로드해서 사용할때 이줄만 활성화  나머진 ## 처리####
    #ADAPTIVE_BED_MESH_CALIBRATE                   ### ADAPTIVE BED_MESH_CALIBRATE ####
    BED_MESH_CALIBRATE                             ### BED_MESH_CALIBRATE ####
    
       # SET_DISPLAY_TEXT MSG="CARTOGRAPHER TOUCH LEVELing"    
    # CARTOGRAPHER_TOUCH_V3                  ### CARTOGRAPHER_TOUCH LEVELing ####
    M109 S150
    
    SET_DISPLAY_TEXT MSG="nozzl fuzing" 
    clean_nozzle
    
    STATUS_HOMING
    SET_DISPLAY_TEXT MSG="CARTOGRAPHER HOMEING" 
    CARTOGRAPHER_TOUCH_HOME ; Home for real Z0       CARTOGRAPHER
     
     {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
    M104 S{EXTRUDER_TEMP}     # Heat extruder and wait
    M109 S{EXTRUDER_TEMP}     # Heat extruder and wait
   
    STATUS_PRINTING
    SET_DISPLAY_TEXT MSG="nozzle Draw" 
    G91 E0.0                          ; Reset Extruder
    G90                               # 지우지말것!
    G1 Z10 F3000                      ; move nozzle away from bed
    G1 X10.2 Y20 Z0.5 F5000.0         ; Move to start position
    M221 S100                         ; 압출량 100%로 설정    
    G1 X10.2 Y450.0 Z0.3 F3000.0 E15  ; Draw the first line
    G1 X11.0 Y450.0 Z0.3 F5000.0      ; Move to side a little
    G1 X11.0 Y20 Z0.3 F3000.0 E30     ; Draw the second line
    G92 E0.0                          ; Reset Extruder
    G1 Z2.0 F3500                     ;  Move Z Axis up little to prevent scratching of Heat Bed
    SET_DISPLAY_TEXT MSG="NOW PRINTING" 
    G90                               # Switch back to absolute positioning   퍼지후 센터에서 출력시작 (지우지말것!)


##########################################################################################################################################   
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
##########################################################################################################################################
#[gcode_macro print_end]
#gcode:
#    STATUS_BUSY
#    M400                           ; wait for buffer to clear
#    G91                            ; relative positioning
#    G92 E0                         ; zero the extruder
#    G1 X-2 Y-2 E-3 F300            ; retract filament  
#    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
#    TURN_OFF_HEATERS
#    G1 Z5 F3000                    ; move nozzle up 5mm
#    G90                            ; absolute positioning
#    G0 X710 Y490 F3600            ; park nozzle at rear
#    #G0 X710 Y50 F3600              ; park nozzle at FRONT
#    BED_MESH_CLEAR
#    STATUS_READY
#    M104 S0                        ; 핫엔드 끄기
#    M140 S0                        ; 베드 끄기 
#    G4 S900                        ; 10분 대기 
#    M106 S0                        ; turn off fan 
#    M84 XYE                        ; Z를 제외한 모든 스테퍼 비활성화
#    M81                            ; ATX Power Off
#    STATUS_OFF

[gcode_macro print_end]
gcode:
    STATUS_BUSY
    M400                            ; wait for buffer to clear
    G91                             ; relative positioning
    G92 E0                          ; zero the extruder
    G1 X-2 Y-2 E-3 F300             ; retract filament  
    G0 Z1.00 X20.0 Y20.0 F20000     ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    G1 Z5 F3000                     ; move nozzle up 5mm
    G90                             ; absolute positioning
    G0 X710 Y490 F3600              ; park nozzle at rear (700 전용 좌표)
    #G0 X710 Y50 F3600              ; park nozzle at FRONT
    BED_MESH_CLEAR
    STATUS_READY
    
    M104 S0                         ; 핫엔드 끄기
    M140 S0                         ; 베드 끄기 
    
    # [수정 포인트] 무조건 15분 대기 대신 노즐 온도 체크!
    # 노즐 온도가 50도 이하로 떨어질 때까지 팬을 돌리며 대기합니다.
    # 50도 도달 시 바로 다음 단계(전원 차단)로 넘어갑니다.
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=50 
    
    M106 S0                         ; turn off fan 
    STATUS_OFF
    M84 XYE                         ; Z를 제외한 모든 스테퍼 비활성화
    M118 퇴근 준비 완료! (테스트 성공)  ; 화면에 메시지 띄우기
    M81                             ; ATX Power Off (라즈베리 파이 GPIO 연동 릴레이 OFF)
       

############################## EXP1 header ################################################################################################
[board_pins]
aliases:
    EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PD6, EXP1_10=<5V>
###########################################################################################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 68.411
#*# pid_ki = 1.390
#*# pid_kd = 841.452
#*#
#*# [input_shaper]
#*# shaper_type_x = 2hump_ei
#*# shaper_freq_x = 95.2
#*# shaper_type_y = 3hump_ei
#*# shaper_freq_y = 49.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.246
#*# pid_ki = 3.176
#*# pid_kd = 50.174
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.030954, -0.001115, -0.031603, -0.062440, -0.087550, -0.099604, -0.098731, -0.106476, -0.102166, -0.093549, -0.070956, -0.048242, -0.031540, -0.039238, -0.054090, -0.068722, -0.073784, -0.078438, -0.043595, 0.002271
#*# 	0.034820, 0.010613, -0.025872, -0.066449, -0.085737, -0.099604, -0.099159, -0.102801, -0.120454, -0.089465, -0.072771, -0.048242, -0.031966, -0.035252, -0.050086, -0.068722, -0.077409, -0.082501, -0.047605, 0.002271
#*# 	0.034820, 0.016243, -0.021918, -0.062440, -0.083500, -0.091472, -0.095083, -0.102801, -0.093771, -0.081521, -0.068724, -0.048663, -0.031966, -0.039238, -0.046088, -0.062680, -0.065280, -0.070341, -0.032028, 0.014056
#*# 	0.049812, 0.025740, -0.013820, -0.046864, -0.067791, -0.075720, -0.079279, -0.086493, -0.081972, -0.073389, -0.052989, -0.036230, -0.020049, -0.019799, -0.038112, -0.045066, -0.047838, -0.046612, -0.012166, 0.044784
#*# 	0.076121, 0.041193, -0.002037, -0.038899, -0.048205, -0.059646, -0.063145, -0.070715, -0.063964, -0.057213, -0.036941, -0.020729, -0.000735, -0.000093, -0.014972, -0.023200, -0.026127, -0.022685, 0.018863, 0.071308
#*# 	0.072736, 0.041193, -0.002037, -0.030961, -0.044220, -0.057854, -0.059347, -0.072524, -0.073862, -0.053606, -0.037361, -0.016763, 0.001229, 0.007745, -0.007308, -0.013320, -0.014248, -0.011231, 0.034015, 0.091848
#*# 	0.095030, 0.063778, 0.016848, -0.015161, -0.028343, -0.040116, -0.043559, -0.058624, -0.054103, -0.041563, -0.028953, 0.010401, 0.022740, 0.023344, 0.014007, 0.009809, 0.005003, 0.015420, 0.060624, 0.120140
#*# 	0.095030, 0.063778, 0.020944, -0.011647, -0.020443, -0.038130, -0.039574, -0.054615, -0.058127, -0.041563, -0.023404, 0.016059, 0.022315, 0.027229, 0.019634, 0.017184, -0.004604, 0.019536, 0.072114, 0.127626
#*# 	0.100680, 0.078987, 0.035998, 0.004028, -0.009060, -0.028218, -0.027657, -0.038612, -0.042500, -0.029570, -0.017442, 0.033589, 0.041709, 0.045931, 0.038997, 0.036578, 0.031858, 0.046474, 0.091140, 0.149543
#*# 	0.113796, 0.082361, 0.047130, 0.015295, 0.002687, -0.016799, -0.019744, -0.031074, -0.038082, -0.006604, 0.005837, 0.037256, 0.037843, 0.063201, 0.050129, 0.055406, 0.058425, 0.065272, 0.112954, 0.169414
#*# 	0.098801, 0.071395, 0.039440, 0.007931, -0.005138, -0.020740, -0.023697, -0.031074, -0.038292, -0.014094, -0.005564, 0.033378, 0.060537, 0.061081, 0.046492, 0.048139, 0.051158, 0.065272, 0.111283, 0.165737
#*# 	0.098801, 0.067589, 0.035998, 0.011828, -0.003181, -0.016588, -0.014037, -0.031074, -0.030532, -0.010134, 0.017603, 0.039193, 0.056701, 0.057251, 0.046287, 0.048139, 0.054589, 0.057606, 0.105842, 0.160213
#*# 	0.095030, 0.063778, 0.035998, 0.007931, -0.007099, -0.016799, -0.017981, -0.031074, -0.034091, -0.018060, 0.013687, 0.037256, 0.056701, 0.049984, 0.042438, 0.047728, 0.051158, 0.061442, 0.103957, 0.156525
#*# 	0.102350, 0.069285, 0.034068, 0.007931, -0.009060, -0.020740, -0.021932, -0.031074, -0.030532, -0.014094, 0.009765, 0.033378, 0.047496, 0.044004, 0.035137, 0.036578, 0.039597, 0.042614, 0.077837, 0.116389
#*# 	0.095030, 0.054222, 0.020520, -0.011647, -0.024389, -0.040116, -0.041353, -0.050605, -0.049880, -0.029997, -0.013476, 0.014317, 0.032031, 0.034557, 0.023519, 0.024961, 0.020628, 0.027112, 0.060830, 0.116389
#*# 	0.083702, 0.048471, 0.011008, -0.015371, -0.032302, -0.044095, -0.047543, -0.058624, -0.057916, -0.045574, -0.025394, 0.002551, 0.018843, 0.015557, 0.004458, 0.001984, 0.005003, 0.004098, 0.041766, 0.090365
#*# 	0.065119, 0.033479, -0.005958, -0.034927, -0.048205, -0.067666, -0.070776, -0.082431, -0.081972, -0.069758, -0.048965, -0.022502, -0.004670, -0.004021, -0.014761, -0.017267, -0.018202, -0.019143, 0.014954, 0.060211
#*# 	0.068930, 0.033479, -0.000289, -0.034927, -0.055767, -0.071690, -0.075236, -0.086493, -0.081972, -0.073389, -0.052989, -0.032239, -0.016089, -0.023335, -0.030587, -0.027163, -0.022161, -0.027082, 0.007116, 0.056364
#*# 	0.038680, 0.010613, -0.021707, -0.054636, -0.075845, -0.095535, -0.099159, -0.102801, -0.102166, -0.093339, -0.080903, -0.056275, -0.043514, -0.042802, -0.050506, -0.052649, -0.053641, -0.054210, -0.024064, 0.014056
#*# 	0.030954, -0.001115, -0.037346, -0.062440, -0.089782, -0.107762, -0.110996, -0.118793, -0.116333, -0.109751, -0.096816, -0.084189, -0.071247, -0.070914, -0.073988, -0.072547, -0.069317, -0.062263, -0.032028, -0.001248
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 650.0
#*# min_y = 30.0
#*# max_y = 500.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.004412, -0.010782, 0.010693, -0.004917, 0.009418
#*# compensation_start_x = 30.0
#*# compensation_end_x = 650.0
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4985763036881294,1.984805115949873,0.7841996311776102,0.19644723621368082,0.6649867093254483,1.2021137101026809,-0.6164723007011578,-1.3625320450205136,0.4714002981180732,0.6835116418212844
#*# domain = 3.2187269673788417e-07,3.308375895562837e-07
#*# z_offset = 0
#*# reference_temperature = 48.18
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.1.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 1819
#*# speed = 2
#*# z_offset = -0.05
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.1.0
